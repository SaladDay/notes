在看日志的时候发现了这句话，发现其实底层设置采样率代码是可以通过上层Java进行修改的，顺藤摸瓜，发现了setSampleRate这个函数。

![image-20230718105143463](https://saladday-figure-bed.oss-cn-chengdu.aliyuncs.com/img/image-20230718105143463.png)

![image-20230718105525619](https://saladday-figure-bed.oss-cn-chengdu.aliyuncs.com/img/image-20230718105525619.png)

![image-20230718111913454](https://saladday-figure-bed.oss-cn-chengdu.aliyuncs.com/img/image-20230718111913454.png)











#### NAT的四种类型

1. Full Cone NAT（完全锥形NAT）

​	所有从同一个私网IP地址和端口（IP1:PORT1）发送过来的请求都会被映射成同一个公网IP地址和端口。并且，任何外部主机通过向映射的公网IP地址和端口发送报文，都可以实现和内部主机进行通讯的功能。

> 这是一种比较宽松的策略，只要建立了私网IP地址与端口和公网IP地址和端口的映射关系，所有的Internet主机都可以访问该NAT之后的主机

2. Restricted Cone NAT（限制锥形NAT）

   与Full Cone NAT不同的是，当且仅当内部主机之前已经向公网主机发送过报文，此时公网主机才能向私网主机发送报文。

3. Port Restriced Cone NAT（端口限制锥形NAT）

   与限制锥形NAT很相似，只不过他同时包括端口号。也就是说，一台公网主机想给私网主机发送报文，必须是这台私网主机先前已经给这个IP地址和端口发送过报文。

4. Stmmetric NAT（对称NAT）

   与上述三者不同，上述三者他们会重复使用外部端口，只要内部IP和端口保持不变。

   在对称NAT中，其会为每一个从同一内部IP地址和端口到不同外部IP地址或端口的会话分配一个新的外部端口。

| Full Cone NAT    | Restricted Cone NAT | Port Restriced Cone NAT | Stmmetric NAT                                                |
| ---------------- | ------------------- | ----------------------- | ------------------------------------------------------------ |
| 最宽松的网络环境 | 增加IP受限          | 增加端口受限            | 内部地址每一次请求一个特定的外部地址，都可能会绑定到一个新的端口号 |
| IP不受限         | IP受限              | IP受限                  | 这种情况，基本告别P2P了                                      |
| 端口不受限       | 端口不受限          | 端口受限                |                                                              |



### STUN服务器略想

STUN服务器的主要用途是帮助 处在NAT或防火墙之后的设备找出他们的公网IP地址。

这对于VoIP这类需要点到点链接的应用来说非常重要，因为NAT或者防火墙的原因会导致请求无法传递到正确的设备上去。

以下是STUN服务器工作流程的简单描述：

1. STUN客户端（位于NAT或是防火墙后的设备），首先会发生一个绑定请求到STUN服务器，这个请求是从客户端（自认为）私有IP和端口发送的、
2. STUN服务器接收到这个请求后，会查看请求的源IP和端口，这通常是经过NAT或防火墙修改后的公共IP和端口，然后，STUN服务器将这些信息作为响应发回STUN客户端。
3. STUN客户端收到STUN服务器的响应后，就能知道自己的公共IP和端口。

值得注意的是，虽然STUN可以处理大多数类型的NAT，但是对于对称型NAT，STUN无能为力。对称性NAT对于每个新的链接（即使是相同源和相同目标）都会分配一个新的外部端口，这意味着STUN服务器返回的端口可能在实际的P2P链接建立时就已经无效。在这种情况下，通常需要使用TURN协议，他通过中继服务器进行数据转发，以解决这个问题。

> 这也就是为什么STUN和TURN常常成对出现的原因。



#### 下面解读一下STUN/TURN服务器返回的结果。

![image-20230723153514165](https://saladday-figure-bed.oss-cn-chengdu.aliyuncs.com/img/image-20230723153514165.png)

- Time：记录候选地址被发现的时间。
- Type：类型
  - host：主机（**相当于内网地址**，这里假设一定有NAT存在）
  - srflx：服务器反射，通过STUN服务器获得（**相当于经过NAT转化后的公网地址**）
  - relay：中继，通过TURN服务器获得

- Priority：优先级。优先级高的将先被尝试建立连接，一般是host>srflx>relay
- 其余的不重要



#### 三种不同类型的候选地址的获取方式

##### 1. host

设备本身通过查询其网络接口生成。

例如上图，我有两个IPv4地址，10.237.56.12和198.18.0.1，其分别为以太网口和无线网口的地址；同时我拥有一个IPv6地址。

##### 2. Srflx

在应用向STUN服务器发送请求的时候，假设你的设备有一个以太网接口和一个无线网接口，每个接口都尝试通过NAT设备与STUN服务器建立一个会话，这样就会生成两个不同的‘srflx’地址。STUN服务器可以知道发起方的IP和端口，其将此数据发回STUN客户端。

例如上图，STUN服务器返回了两个ip相同端口不同的地址，即是不同接口发送的会话形成的srflx地址。

![image-20230723155154639](https://saladday-figure-bed.oss-cn-chengdu.aliyuncs.com/img/image-20230723155154639.png)

##### 3. relay

即在TURN服务器上设置了一个转发，任何发送到该地址的数据都会通过TURN服务器被转发到设备。

![image-20230723155206286](https://saladday-figure-bed.oss-cn-chengdu.aliyuncs.com/img/image-20230723155206286.png)
