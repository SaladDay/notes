---
title: 浅析SSH技术以及免密登录的原理
date: 2022-01-29 16:03:41
tags:
categories: 杂谈
cover:
---

## 介绍SSH

以往的网络通信采用明文传输的方式(Telent)，这种方式一般在公司内网（绝对安全的网络）比较常见。

现在主要的加密算法有两种：对称加密和非对称加密。

- 对称加密使用同一个密钥来进行加密和解密，这样在传输时是安全可靠的。但是如果集群过大，（每一个集群会有一个密钥，那么一个用户会有非常多个密钥）会导致算法复杂以及若一个客户端的的密钥被窃取，则整个系统的安全性便不复存在。
- 非对称加密有两个密钥：公钥和私钥。公钥由私钥产生，但却无法推算出私钥；公钥加密后的密文，只能通过对应的私钥来解密。

## 有三种登录方式：密码登录，密钥登录和All登录

### 1. 密码登录

![img](https://saladday-figure-bed.oss-cn-chengdu.aliyuncs.com/img/v2-210ff11bc3975087dcfde7276417afef_1440w.webp)

初始状态：`topgun`终端要登录`Server`服务器，发起连接请求`ssh work@server.com`

1. 服务端运行有`ssh`服务，因此可以生成一对公钥和私钥；此时将公钥返回给客户端
2. 客户端使用公钥，对登录密码进行加密，（如服务器`work`用户密码为`xxx`），生成公钥加密字符串
3. 客户端将公钥加密字符串发送给服务端
4. 服务端使用私钥，解密公钥加密字符串，得到原始密码
5. 校验密码是否合法（此为本机`work`密码）
6. 返回登录结果给客户端：成功登录或密码错误

在非对称加密中，由于只有公钥会被传输，而私钥是服务端本地保存，因此即便公钥被监听，也无法拿到原始密码，从而登录服务器。

### 2. 免密登入

ssh协议提供一种免密登录的方式：公钥登入。

在这种情况下，登录需要使用到Client的公钥和私钥。

但是！这对密钥只在登录的时候使用，其他时候依旧利用服务器的公钥和私钥来传递数据。

![img](https://saladday-figure-bed.oss-cn-chengdu.aliyuncs.com/img/v2-787f86e9506fe7844d93cc0ecf187cb1_1440w.webp)

1. 在客户端使用`ssh-keygen`生成一对密钥：公钥+私钥

2. 将客户端公钥追加到服务端的`authorized_key`文件中，完成公钥认证操作

3. 认证完成后，客户端向服务端发起登录请求，并传递公钥到服务端

4. 服务端检索`authorized_key`文件，确认该公钥是否存在

   

5. 如果存在该公钥，则生成随机数`R`，并用公钥来进行加密，生成公钥加密字符串`pubKey(R)`

6. 将公钥加密字符串传递给客户端

7. 客户端使用私钥解密公钥加密字符串，得到`R`

8. 服务端和客户端通信时会产生一个会话`ID(sessionKey)`，用`MD5`对`R和SessionKey`进行加密，生成摘要（即`MD5`加密字符串）

9. 客户端将生成的`MD5`加密字符串传给服务端

10. 服务端同样生成`MD5(R,SessionKey)`加密字符串

11. 如果客户端传来的加密字符串等于服务端自身生成的加密字符串，则认证成功

12. 此时不用输入密码，即完成建连，可以开始远程执行`shell`命令了

5-11步用简介的语言来说：服务器生成一个随机字符串(展开来说就是上述的过程)并用客户端的公钥加密，返回客户端，客户端利用私钥解密后返回服务器，服务器比对解密结果是否正确。（其实就是检查一下，发送公钥的这个服务器有没有私钥，是不是正版客户端）

### 3. ALL登录

即上述两种方式均可登入。
